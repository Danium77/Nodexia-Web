import React, { useEffect, useState } from 'react';
import { useRouter } from 'next/router';
import { supabase } from '../lib/supabaseClient';
import { useUserRole } from '../lib/contexts/UserRoleContext'; // 游댠 Usar Context centralizado
import { usePageVisibility } from '../lib/hooks/usePageVisibility'; // 游댠 Evitar reloads

import Header from '../components/layout/Header';
import Sidebar from '../components/layout/Sidebar';
import InicioDashboard from '../components/Dashboard/InicioDashboard';

interface Dispatch {
  id: string;
  pedido_id: string;
  origen: string;
  destino: string;
  estado: string;
  scheduled_at: string;
  created_by: string;
  transport_id: string;
  driver_id: string;
  type?: string;

  transporte_data?: { nombre: string };
  creador?: { nombre_completo: string; };
  chofer?: { nombre_completo: string; };
}

const Dashboard = () => {
  const router = useRouter();
  const { user, primaryRole, loading } = useUserRole();
  const [redirected, setRedirected] = useState(false); // Flag para evitar m칰ltiples redirects

  // Redirecci칩n 칔NICA basada en rol
  useEffect(() => {
    // Solo ejecutar si no se ha redirigido ya
    if (redirected || loading) return;

    if (!user) {
      setRedirected(true);
      router.replace('/login'); // replace en lugar de push para no agregar a history
      return;
    }

    // Redirigir seg칰n rol
    if (primaryRole === 'super_admin') {
      setRedirected(true);
      router.replace('/admin/super-admin-dashboard');
      return;
    }

    if (primaryRole === 'coordinador') {
      setRedirected(true);
      router.replace('/coordinator-dashboard');
      return;
    }

    // Si no tiene rol v치lido, redirigir a login
    if (primaryRole && !['super_admin', 'coordinador'].includes(primaryRole)) {
      setRedirected(true);
      router.replace('/login');
    }
  }, [user, primaryRole, loading, redirected, router]);

  // Mostrar loading mientras redirige
  if (loading || redirected) {
    return (
      <div className="flex items-center justify-center min-h-screen bg-[#0a0e1a]">
        <div className="text-center">
          <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-cyan-500 mx-auto mb-4"></div>
          <p className="text-slate-400">Redirigiendo...</p>
        </div>
      </div>
    );
  }

  // Si llegamos aqu칤 sin redirecci칩n, mostrar error
  return (
    <div className="flex items-center justify-center min-h-screen bg-[#0a0e1a]">
      <div className="text-center">
        <p className="text-slate-400">Error: No se pudo determinar el dashboard apropiado</p>
        <button 
          onClick={() => router.push('/login')}
          className="mt-4 px-4 py-2 bg-cyan-600 text-white rounded hover:bg-cyan-700"
        >
          Volver al Login
        </button>
      </div>
    </div>
  );
};

export default Dashboard;

// NOTA: Este archivo es solo un redirector.
// El contenido real est치 en:
// - /admin/super-admin-dashboard (para super_admin)
// - /coordinator-dashboard (para coordinador)

/* C칍DIGO VIEJO ELIMINADO - Ya no se usa este dashboard para mostrar contenido

  // Obtener nombre del usuario para mostrar
  useEffect(() => {
    const fetchUserName = async () => {
      if (!user) return;
      
      const { data: userData, error: userError } = await supabase
        .from('usuarios')
        .select('nombre_completo')
        .eq('email', user.email)
        .maybeSingle();

      if (userError || !userData || !userData.nombre_completo) {
        console.log("丘멆잺 Nombre completo no encontrado, usando email");
        setUserName(user.email?.split('@')[0] || 'Usuario');
      } else {
        setUserName(userData.nombre_completo);
      }
    };

    fetchUserName();
  }, [user]);

  // Cargar despachos
  useEffect(() => {
    const fetchDispatches = async () => {
      // TEMPORALMENTE DESHABILITADO - Error en relaci칩n despachos-transportes
      console.log('[Dashboard] fetchDispatches deshabilitado temporalmente');
      setLoadingDispatches(false);
      return;
      
      /*
      setLoadingDispatches(true);
      setErrorDispatches(null);
      
      const { data, error } = await supabase
        .from('despachos')
        .select(`
          id,
          pedido_id,
          origen,
          destino,
          estado,
          scheduled_at,
          created_by,
          transport_id,
          driver_id,
          type,
          transporte_data:transportes!despachos_transporte_id_fkey(
            nombre
          ),
          creador:usuarios!despachos_created_by_fkey(
            nombre_completo
          ),
          chofer:usuarios!despachos_driver_id_fkey(
            nombre_completo
          )
        `)
        .order('scheduled_at', { ascending: true });

      if (error) {
        console.error('Error al cargar despachos:', error);
        setErrorDispatches('Error al cargar despachos: ' + error.message);
      } else {
        const filteredData = data ? data.filter(d => d.scheduled_at) : [];
        // Map nested arrays to objects as expected by Dispatch type
        const mappedData: Dispatch[] = filteredData.map((d: any) => ({
          ...d,
          transporte_data: d.transporte_data && Array.isArray(d.transporte_data) ? d.transporte_data[0] : d.transporte_data,
          creador: d.creador && Array.isArray(d.creador) ? d.creador[0] : d.creador,
          chofer: d.chofer && Array.isArray(d.chofer) ? d.chofer[0] : d.chofer,
        }));
        setDispatches(mappedData);
        console.log('Despachos cargados:', mappedData);
      }
      setLoadingDispatches(false);
      */
    };

    fetchDispatches();
  }, []);

  if (!user || loading) {
    return (
      <div className="min-h-screen flex items-center justify-center bg-[#0e1a2d] text-slate-100">
        Cargando Dashboard...
      </div>
    );
  }

  return (
    <div className="flex min-h-screen bg-[#0e1a2d]">
      <Sidebar userEmail={user.email || ''} userName={userName} />
      <div className="flex-1 flex flex-col">
        <Header userEmail={user.email || ''} userName={userName} pageTitle="Tablero de Control Principal" />
        <main className="flex-1 p-6">
          {loadingDispatches ? (
            <p className="text-slate-300">Cargando despachos...</p>
          ) : errorDispatches ? (
            <p className="text-red-400">Error al cargar datos: {errorDispatches}</p>
          ) : (
            <>
              {/* New InicioDashboard: visi칩n global con KPIs, mapa y widgets */}
              <section className="flex flex-col gap-6">
                {/* Lazy import the dashboard component */}
                <InicioDashboard dispatches={dispatches} />
              </section>
            </>
          )}
        </main>
      </div>
    </div>
  );
};

export default Dashboard;