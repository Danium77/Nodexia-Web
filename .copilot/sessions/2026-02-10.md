# Sesión 9 — 10-Feb-2026

## Resumen
Fix de criterios de documentación dinámicos (chofer dependencia vs autónomo), modal de documentación detallada, alias de tipos de documento, y cierre de seguridad con auditoría completa.

## Contexto de Entrada
- Sesión 8 terminó con testing end-to-end exitoso de todos los flujos
- Se identificó que control de acceso bloqueaba chofer por "Seguro de Vida faltante" cuando era bajo relación de dependencia (necesita ART, no seguro vida)
- RLS fix (migration 052) y API bypass removal completados

## Cambios Realizados

### 1. Criterios de Documentación Dinámicos
- `verificar-documentacion.ts`: nueva función `getDocsCriticosChofer()` que consulta `choferes.empresa_id → empresas.tipo_empresa`
- Si tipo_empresa = 'transporte' → dependencia → ART + cláusula
- Si no → autónomo → seguro de vida
- Misma lógica en `alertas.ts` (usa tipo_empresa del usuario) y `estado-batch.ts` (batch lookup)

### 2. Alias de Tipos de Documento
- `normalizarTipoDoc()` en 3 archivos: vtv→rto, tarjeta_verde/cedula_verde→cedula
- Resuelve discrepancia entre esquema viejo (046_original) y esquema nuevo (046_CORREGIDO)

### 3. Modal Documentación Detallada
- CAUSA: DocumentacionDetalle.tsx usaba `supabase` client (RLS) → usuario control-acceso sin permisos → modal vacío
- FIX: Nueva API `documentos-detalle.ts` (supabaseAdmin), DocumentacionDetalle.tsx actualizado

### 4. Seguridad (continuación sesión 8)
- Migration 052 aplicada por usuario
- /api/recursos/por-ids eliminado
- 4 archivos revertidos de bypass a queries directas
- Auth APIs corregidas (usuarios_empresa.rol_interno)
- Auditoría completa registrada en docs/PENDIENTE-CRITICO-SEGURIDAD-API.md

## Archivos Modificados
```
CREADOS:
- pages/api/control-acceso/documentos-detalle.ts
- docs/PENDIENTE-CRITICO-SEGURIDAD-API.md
- sql/migrations/052_fix_rls_visible_recursos.sql

MODIFICADOS:
- pages/api/control-acceso/verificar-documentacion.ts
- pages/api/documentacion/alertas.ts
- pages/api/documentacion/estado-batch.ts
- components/DocumentacionDetalle.tsx
- pages/api/documentacion/validar.ts
- pages/api/documentacion/preview-url.ts
- pages/api/documentacion/pendientes.ts
- pages/control-acceso.tsx
- pages/crear-despacho.tsx
- pages/planificacion.tsx

ELIMINADOS:
- pages/api/recursos/por-ids.ts
```

## Decisiones
- DEC-008: Criterios docs dinámicos por tipo chofer
- DEC-009: Alias de tipos para compatibilidad legacy
- DEC-010: Seguridad diferida a post-MVP con registro formal
- DEC-011: Modal de docs usa API server-side (no client RLS)

## Bugs Nuevos (reportados al cierre)
1. Control de acceso bloquea por "por vencer" (debería ser solo advertencia)
2. Incidencias 500 (API crear-incidencia falla)
3. Upload docs 500 (SubirDocumento handleSubmit falla)

## Plan Próxima Sesión
- Fix 3 bugs pendientes
- Definir circuito de incidencias
- Polish para demo (quedan 8 días)
