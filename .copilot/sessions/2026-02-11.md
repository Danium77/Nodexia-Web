# Sesión 12 — 11-Feb-2026

## Hardening + Red Nodexia + Esquema Definitivo Estados

**Duración:** ~2.5 horas  
**Participantes:** Opus (Tech Lead) + Usuario (PO/Tester)  
**Días para demo:** 7

---

## Objetivos de la Sesión

1. Hardening de seguridad pre-demo
2. Corregir bugs de Red Nodexia (viajes no expandían, datos stale, tab mal categorizado)
3. Diseñar e implementar esquema definitivo de estados para viajes

---

## Trabajo Realizado

### 1. Hardening de Seguridad (commit e3b8e29)

**Problema:** Múltiples API routes peligrosas expuestas (debug, test, bypass, delete-all, sincronización masiva).

**Solución:**
- Eliminadas ~20 API routes peligrosas
- GPS auth bypass corregido (validar JWT antes de guardar ubicación)
- Security headers en next.config.ts: Content-Security-Policy, X-Frame-Options, X-Content-Type-Options, Referrer-Policy, Permissions-Policy, Strict-Transport-Security
- Leaked Supabase service_role key removida de docs/CREDENCIALES-DEV.md
- Password hardcodeada "NodPass2025!" reemplazada por crypto.randomBytes(16) en nueva-invitacion.ts

### 2. Fix Viajes No Se Expandían (commit a786b89)

**Problema:** Al clickear "Viajes" en lista de despachos, no se mostraban los viajes.

**Causa raíz:** Query de Supabase con joins complejos (`estado_carga_viaje`, `camiones`, `choferes`, `acoplados`) fallaba silenciosamente — las tablas no existían o los foreign keys no eran correctos.

**Solución:** Simplificado a `select('*')` — datos de entidades se buscan por separado cuando se necesitan.

### 3. Fix Red Nodexia Datos Stale (commit d0cac1c)

**Problema:** Viaje en Red Nodexia mostraba chofer/camión/acoplado con datos del transporte anterior, antes de que se confirmara una nueva oferta.

**Solución:** Cuando `esRedNodexia && !estaEnMovimiento(estado)`:
- Badge "En Red Nodexia" en vez del nombre del chofer
- "Esperando oferta" en vez de datos de camión/acoplado
- Dashes (—) para campos de recursos

### 4. Tab Categorización - Múltiples Iteraciones (commits 4ea02da, 4e34c1f, aafba23)

**Problema:** Despacho DSP-20260210-001 (Red Nodexia, 18+ horas de retraso, sin recursos confirmados) aparecía en tab "Demorados" en vez de "Expirados".

**Iteración 1 (4ea02da):** Agregado `'pendiente'` a ESTADOS_CARGA_PENDIENTES → no funcionó (estado era `camion_asignado`).

**Iteración 2 (4e34c1f):** Blacklist de estados pre-operativos → no funcionó (no cubría todos los casos).

**Iteración 3 (aafba23):** Whitelist de estados físicamente en movimiento → parcial (badge count fijo pero despacho aún en Demorados).

### 5. Esquema Definitivo de Estados (commit 9efe9a7)

**Decisión:** Reescribir completamente `lib/estadosHelper.ts` en vez de seguir parcheando.

**22 estados en 7 fases:**
```
Fase 0: pendiente
Fase 1: transporte_asignado → camion_asignado → confirmado_chofer
Fase 2: en_transito_origen → arribo_origen
Fase 3: ingresado_origen → en_playa_origen → llamado_carga → cargando → cargado → egreso_origen
Fase 4: en_transito_destino → arribo_destino (→ arribado_destino si destino sin Nodexia)
Fase 5: ingresado_destino → llamado_descarga → descargando → descargado → egreso_destino
Fase 6: vacio → viaje_completado (auto)
X: cancelado
```

**Tab categorización exclusiva (prioridad):**
1. Completados: estado completado/entregado
2. Expirados: viajes sin recursos, fuera de ventana 2h
3. Demorados: viajes CON recursos, fuera de ventana (excluye expirados)
4. Pendientes: sin viajes asignados (excluye expirados/completados)
5. En Proceso: parcialmente asignado (excluye expirados/demorados)
6. Asignados: todos asignados (excluye expirados/demorados)

**API:** `arribo_destino` ahora permite → `arribado_destino` (para destinos que no usan Nodexia).

---

## Archivos Afectados

### Eliminados (~20):
- APIs de debug, test, bypass, borrado masivo

### Reescritos (1):
- `lib/estadosHelper.ts` — Esquema definitivo completo

### Modificados (5):
- `pages/crear-despacho.tsx` — Red Nodexia override + tab categorización + badges
- `pages/api/viajes/[id]/estado-unidad.ts` — Transición arribo_destino → arribado_destino
- `next.config.ts` — Security headers
- `pages/api/gps/save-location.ts` — Auth fix JWT
- `pages/admin/nueva-invitacion.ts` — Hardcoded password → crypto.randomBytes

---

## Decisiones Técnicas

1. **estadosHelper.ts como SSOT:** Fuente única de verdad para categorización de estados
2. **Membresía exclusiva de tabs:** Un despacho solo puede estar en UN tab a la vez
3. **En planta = siempre activo:** Si el camión está físicamente en planta, no importa la ventana de tiempo
4. **estaEnMovimiento() canónico:** Reemplaza listas hardcodeadas en múltiples archivos
5. **Backward-compatible:** Aliases `ESTADOS_CARGA_EN_PROGRESO`, `estaEnProgreso()` mantienen compatibilidad

---

## Próxima Sesión (Sesión 13)

### Prioridad:
1. **TASK-S26:** Fase 5 — Destino con Nodexia (CA ingreso/egreso destino + supervisor descarga)
2. **TASK-S27:** Cierre automático viaje (vacío → viaje_completado)
3. **TASK-S28:** Sincronización estado viaje ↔ despacho
4. **TASK-S25:** Polish para demo (7 días restantes)
