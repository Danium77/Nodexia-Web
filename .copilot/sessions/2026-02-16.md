# Sesión 24 — 16-Feb-2026 (Lunes)

## Security + Performance Audit + Team Docs

**Tiempo:** Estimado ~3 horas  
**Equipo:** Opus (Tech Lead) + Usuario (PO)  
**Nota:** Sesión sin cierre formal — contexto reconstruido de git history

---

## Resumen Ejecutivo

Auditoría de seguridad y performance previo a la demo del 18-Feb. Se corrigieron vulnerabilidades IDOR en 4 APIs, se agregó CSP header, ErrorBoundary global, y se ejecutó la migración 060 con 11 indexes de performance + funciones de limpieza con pg_cron. Se inició la documentación para equipos.

---

## Security Fixes

### 1. IDOR Fix: preview-url
- **Vulnerabilidad:** No validaba que el documento perteneciera a la empresa del usuario
- **Fix:** Validación de empresa + protección contra path traversal

### 2. IDOR Fix: GPS APIs
- **Afectados:** `estadisticas-viaje.ts`, `ubicaciones-historicas.ts`
- **Vulnerabilidad:** No verificaban scope de empresa
- **Fix:** Agregado empresa scope verification

### 3. IDOR Fix: Timeline
- **Afectado:** `despachos/timeline.ts`
- **Vulnerabilidad:** Cualquier usuario autenticado podía ver timeline de cualquier despacho
- **Fix:** Filtro por empresa_id del usuario

### 4. Role Restrictions
- `notificar-recepcion.ts` — Restringido a coordinador/admin
- `documentos-detalle.ts` — Restringido a roles autorizados
- `crear-incidencia.ts` — Restringido a chofer/control_acceso

### 5. Error Sanitization
- 3 APIs exponían `error.message` interno → reemplazado por mensajes genéricos

### 6. demo-qr Bloqueado
- Bloqueado en producción (solo funciona en desarrollo)
- Passwords hardcodeados removidos

### 7. Supabase Singletons
- 7 archivos creaban `createClient()` duplicado → reemplazados por import del singleton

---

## Stability

### ErrorBoundary Global
- `components/ErrorBoundary.tsx` creado (99 líneas)
- Agregado a `_app.tsx` envolviendo la app completa
- Muestra UI de error amigable con botón de retry

---

## Performance (Migración 060 — ✅ EJECUTADA EN PROD)

### 11 Indexes
```sql
idx_viajes_despacho_estado, idx_viajes_despacho_chofer, idx_viajes_despacho_transport,
idx_viajes_despacho_despacho, idx_viajes_despacho_created,
idx_choferes_empresa, idx_choferes_user,
idx_notificaciones_user, idx_notificaciones_leida,
idx_despachos_empresa, idx_despachos_estado
```

### 3 Funciones de Limpieza
- `limpiar_tracking_gps_antiguos()` — Elimina GPS > 90 días
- `limpiar_ubicaciones_antiguas()` — Elimina ubicaciones > 90 días
- `limpiar_notificaciones_leidas()` — Elimina notificaciones leídas > 30 días

### pg_cron
- 3 jobs activados en PROD para limpieza diaria

---

## Team Docs

- `docs/equipos/FRONTEND.md` — Guía frontend (249 líneas)
- `docs/equipos/BACKEND-API.md` — Guía backend API (302 líneas)

---

## Google Verification

- `public/googlefd751202f9d68d7a.html` — Para Google Search Console

---

## Commits

| Hash | Fecha | Descripción |
|------|-------|-------------|
| `60e35fb` | 16-Feb | security+performance audit: IDOR fixes, CSP, ErrorBoundary, indexes, cron cleanup |
| `0084ddd` | 17-Feb | Añadiendo verificación de Google + team docs |

---

## Archivos Modificados (23 total)

```
components/Admin/DashboardNodexia.tsx           — Supabase singleton
components/Admin/GestionEmpresasReal.tsx         — Supabase singleton
components/Admin/WizardOnboarding.tsx            — Supabase singleton
components/ErrorBoundary.tsx                     — NUEVO
components/Transporte/TimelineEstados.tsx        — Supabase singleton
next.config.ts                                   — CSP headers
pages/_app.tsx                                   — ErrorBoundary wrapper
pages/admin/clientes.tsx                         — Supabase singleton
pages/admin/clientes/[id].tsx                    — Supabase singleton
pages/admin/setup-db.tsx                         — Supabase singleton
pages/api/control-acceso/crear-incidencia.ts     — Role restriction
pages/api/control-acceso/documentos-detalle.ts   — Role restriction
pages/api/despachos/timeline.ts                  — IDOR fix
pages/api/documentacion/estado-batch.ts          — Error sanitization
pages/api/documentacion/preview-url.ts           — IDOR fix + path traversal
pages/api/gps/estadisticas-viaje.ts              — IDOR fix
pages/api/gps/ubicaciones-historicas.ts          — IDOR fix
pages/api/notificaciones/notificar-recepcion.ts  — Role restriction
pages/demo-qr.tsx                                — Blocked in PROD
docs/equipos/BACKEND-API.md                      — NUEVO
docs/equipos/FRONTEND.md                         — NUEVO
public/googlefd751202f9d68d7a.html               — NUEVO
sql/migrations/060_indices_performance_y_retencion.sql — NUEVO
```
