# Sesión 16-17 — 13-Feb-2026

## Centralización Completa de Estados

**Duración:** ~5 horas (2 sesiones continuas)  
**Equipo:** Opus (Tech Lead) + Usuario (PO)

---

## Objetivo
Reestructurar arquitectónicamente el sistema de estados para escalabilidad de equipo.
Migrar de 22 estados dispersos a 17+1 centralizados con services layer.

---

## Trabajo Completado

### 1. Sistema de estados centralizado
- `lib/estados/config.ts` — 17+1 estados, 7 fases
- Exports: EstadoViaje enum, TRANSICIONES_VALIDAS, ORDEN_ESTADOS, ESTADO_DISPLAY, ROLES_AUTORIZADOS
- Funciones: validarTransicion, getProximosEstados, puedeActualizar, calcularProgreso, getEstadoDisplay
- Legacy mapping para backward compatibility

### 2. Services layer
- `lib/services/viajeEstado.ts`:
  - cambiarEstadoViaje() — sincroniza viajes_despacho + despachos + estado_unidad_viaje
  - asignarUnidad() — asigna chofer+camión+acoplado
  - verificarChoferViaje() — auth check
  - ESTADO_A_TIMESTAMP — mapea cada estado a su columna timestamp
- `lib/services/notificaciones.ts`:
  - notificarCambioEstado() — notificación centralizada
  - notificarUsuario() — notificación genérica

### 3. Purga de estados obsoletos
30+ archivos limpiados. Estados eliminados del código ejecutable:
arribo_origen, arribo_destino, en_playa_origen, viaje_completado, entregado, vacio,
disponible_carga, en_playa_espera, en_proceso_carga, ingreso_planta, ingreso_destino, en_descarga

### 4. confirmar-accion.ts reescrito
- ANTES: RPC validar_transicion_estado_unidad + función local crearNotificacionChofer (50 líneas)
- DESPUÉS: cambiarEstadoViaje() + notificarCambioEstado() — thin route

### 5. cancelarViaje() centralizado
- ANTES: update directo en estado_unidad_viaje (bypasaba cambiarEstadoViaje)
- DESPUÉS: fetch a /api/viajes/[id]/estado-unidad → cambiarEstadoViaje()

### 6. Lectura estandarizada
- Todos los archivos: `estado || estado_unidad` (estado es canónico)
- estados-camiones.tsx: query cambiada de .in('estado_unidad') a .in('estado')

### 7. SQL Migrations
- 058: Migración estados legacy + tabla paradas multi-destino ✅ EJECUTADA
- 059: Unificar estado_unidad_viaje + CHECK constraint ✅ EJECUTADA

### 8. Tests
- 56 tests en `__tests__/lib/estados-config.test.ts`
- Cubren: completeness, transitions, happy-path chain, cancelation rules,
  role authorization, legacy mapping, progress calculation, graph integrity (BFS)
- Todos pasan ✅

### 9. 0 TypeScript errors ✅

---

## Archivos Creados
| Archivo | Líneas | Descripción |
|---------|--------|-------------|
| lib/estados/config.ts | ~750 | Fuente única de verdad |
| lib/estados/index.ts | ~10 | Re-exports |
| lib/services/viajeEstado.ts | ~370 | Service de estados |
| lib/services/notificaciones.ts | ~80 | Service de notificaciones |
| sql/migrations/058_centralizacion_estados_y_paradas.sql | ~250 | SQL migration |
| sql/migrations/059_unificar_estado_unidad_viaje.sql | ~90 | SQL migration |
| __tests__/lib/estados-config.test.ts | ~400 | 56 tests |

## Archivos Modificados (30+)
Purga de estados obsoletos + estandarización de reads en:
crear-despacho.tsx, despachos.tsx, notificaciones.tsx, types/network.ts,
MonthView.tsx, DayView.tsx, estados-camiones.tsx, supervisor-carga.tsx,
viajes-activos.tsx, despachos-ofrecidos.tsx, tracking-flota.tsx, demo-qr.tsx,
configuracion/transportes.tsx, actualizar-ubicacion.ts, escanear-qr.ts,
chofer/viajes.ts, confirmar-accion.ts, control-acceso.tsx,
lib/api/estado-unidad.ts, lib/estadosHelper.ts, sync-usuarios.test.ts

---

## Decisiones Técnicas Clave
1. **lib/estados/config.ts** como FUENTE ÚNICA — reemplaza estadosHelper.ts y estados-helpers.ts
2. **campo `estado`** es canónico — `estado_unidad` es legacy sync
3. **cambiarEstadoViaje()** como ÚNICO punto de escritura — service pattern
4. **Timestamps automáticos** via ESTADO_A_TIMESTAMP mapping en estado_unidad_viaje
5. **Legacy mapping** en getEstadoDisplay() para no romper UI con datos viejos
6. **Graph integrity tests** (BFS) para prevenir estados huérfanos en el futuro

---

## Próxima Sesión
1. Centralizar estado_carga_viaje (service análogo para carga)
2. Fix actualizarEstadoDual() silencioso en supervisor-carga.tsx
3. Renombrar prop estado_unidad → estado en ViajeEstado interface
4. TASK-S24: Deploy staging (Vercel) — Demo 18-Feb
5. TASK-S25: Testing con data real
