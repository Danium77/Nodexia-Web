# Sesión 26 — 18-Feb-2026

## Resumen
**Foco:** Correcciones UX + Arquitectura de seguridad RLS (CERO bypass)
**Duración:** ~4 horas
**Equipo:** Opus (Tech Lead) + Usuario (PO)

---

## Logros

### 1. Drag & Drop Planning Grid
- Fix event propagation y scrolling
- Fix headers visibilidad (sticky top-0)
- Eliminados dual scroll bars
- Rango extendido a 24 horas (00:00-23:00)
- `canBeDragged()`: solo estados antes de `confirmado_chofer`

### 2. Unidad Operativa - Prevención de Duplicados
- Validación chofer+camion combo antes de insert
- Dropdowns filtrados: solo choferes/camiones/acoplados no asignados
- Error claro si combo ya existe

### 3. Control de Acceso - Validación de Documentación Real
- Eliminado `documentacion_validada: true` hardcodeado
- Creada `validarDocumentacionCompleta()` que consulta docs reales vía API
- Botón "Confirmar Ingreso" deshabilitado cuando docs inválidos
- Warning message visible cuando documentación incompleta

### 4. CSP Fix para Document Preview
- Agregado `https://*.supabase.co` a `frame-src` en next.config.ts
- Admin Nodexia ahora puede previsualizar documentos en iframes

### 5. Fix 401 Errors para Control de Acceso
- `useDocAlerts` hook: manejo silencioso de 401/403
- `validarDocumentacionCompleta()`: migrado de Supabase client directo a API endpoint
- Auth session missing: redirect a /login en UserRoleContext

### 6. PRINCIPIOS DE ARQUITECTURA Y SEGURIDAD (MANDATO PO)
- Documentados 6 principios inquebrantables en QUICK-START-OPUS.md
- CERO bypass RLS, CERO inserts directos, CERO parches
- CUIT como dato común entre entidades
- Separación BD/Backend/Frontend/Mobile
- Checklist de validación pre-commit

### 7. Migration 062: RLS Cross-Company para documentos_entidad
- **3 funciones corregidas:** `get_visible_chofer_ids()`, `get_visible_camion_ids()`, `get_visible_acoplado_ids()`
  - Branch 2: de `d.origen_empresa_id` (nunca poblado) → JOIN a `ubicaciones.empresa_id` vía `despachos.origen_id/destino_id`
  - Branch 3: de `vd.empresa_id` (no existe) → `vd.id_transporte`
  - COALESCE para dual column names (chofer_id/id_chofer, etc.)
  - Admin bypass para admin_nodexia y super_admins
- **Policy actualizada:** `documentos_entidad` SELECT incluye cross-company vía `get_visible_*_ids()`
- **supabaseServerClient.ts creado:** `createUserSupabaseClient(token)` para queries con RLS desde API routes
- **withAuth.ts actualizado:** `AuthContext.token` para crear cliente user-scoped
- **documentos-detalle.ts refactorizado:** eliminado `supabaseAdmin` → `createUserSupabaseClient`
- **preview-url.ts refactorizado:** permiso verificado por RLS (mantiene supabaseAdmin solo para storage signed URLs)
- **Sync files actualizados:** sync_prod_part4_functions.sql + sync_prod_part6_security.sql

---

## Decisiones Tomadas

### DEC-015: CERO bypass RLS para usuarios autenticados (18-Feb-2026)
- **Mandato del PO** — Principio permanente
- `supabaseAdmin` solo permitido para: verificar JWT, obtener rol, storage signed URLs, migraciones, cron
- Patrón: `withAuth` → `auth.token` → `createUserSupabaseClient(token)` → RLS

### DEC-016: Obsoleta DEC-011 (18-Feb-2026)
- DEC-011 decía "usar supabaseAdmin para datos cross-empresa"
- **Reemplazada** por: RLS policies con `get_visible_*_ids()` functions que evalúan visibilidad cross-company
- El bypass ya no es necesario gracias a la migration 062

---

## Archivos Creados
- `sql/migrations/062_fix_rls_documentos_cross_company.sql`
- `lib/supabaseServerClient.ts`
- `.copilot/sessions/2026-02-18.md`

## Archivos Modificados
- `lib/middleware/withAuth.ts` — token en AuthContext
- `pages/api/control-acceso/documentos-detalle.ts` — eliminado supabaseAdmin
- `pages/api/documentacion/preview-url.ts` — permiso por RLS
- `pages/control-acceso.tsx` — validación real de docs, comentarios actualizados
- `sql/sync_prod_part4_functions.sql` — funciones corregidas
- `sql/sync_prod_part6_security.sql` — policy actualizada
- `docs/QUICK-START-OPUS.md` — principios + implementación técnica
- `next.config.ts` — CSP frame-src
- `lib/contexts/UserRoleContext.tsx` — redirect /login
- `lib/hooks/useDocAlerts.ts` — manejo silencioso 401/403
- `components/DocumentacionDetalle.tsx` — migrado a API
- `components/Planning/PlanningGrid.tsx` — drag & drop fixes
- `components/Transporte/CrearUnidadModal.tsx` — duplicate prevention

---

## Pendiente para Próxima Sesión
1. **Ejecutar migration 062 en Supabase** (SQL Editor)
2. **Testear control-acceso con usuario control_acceso** después de migration
3. **Otros endpoints control-acceso** aún usan supabaseAdmin: `verificar-documentacion.ts`, `escanear-qr.ts`, `crear-incidencia.ts`, `confirmar-accion.ts`
4. **DEC-011 obsoleta** — actualizar DECISIONS.md
5. **Preparación demo** 28-Feb-2026
