# Sesión 29 — 21-Feb-2026

## Badge Unificación + Despachos Tab Fix + Incidencias API Fix

**Duración:** ~3 horas  
**Equipo:** Opus (Tech Lead) + Usuario (PO)

---

## Resumen

Sesión enfocada en bugs de UI y la primera prueba real de creación de incidencias. Se unificaron badges de estados-camiones, se corrigió la clasificación de despachos en tabs, y se resolvió el error 500 en la API de incidencias.

---

## Cambios Detallados

### 1. Badges unificados estados-camiones
**Problema:** supervisor_carga mostraba badges diferentes a estados-camiones.  
**Causa:** Condicional `esControlAcceso` dividía entre 11 badges detallados y 6 simplificados.  
**Fix:** Eliminado condicional. Todos los roles ven 6 badges: Todos, En Planta, Por Arribar, Cargando, Descargando, Egresados.  
**Archivo:** `pages/estados-camiones.tsx`

### 2. Despachos en tabs incorrectos
**Problema:** DSP-20260221-001 con viaje "cargado" pero despacho "cancelado" aparecía en tab "Completados".  
**Causa:** Filtro solo verificaba `d.estado` de la BD sin considerar estado real de los viajes.  
**Fix:** 
- Flags `tiene_viajes_en_proceso` y `todos_viajes_completados` computados desde viajes
- Tab "En Proceso" captura despachos con viajes activos independientemente del estado del despacho
- Estado visual se computa: viajes activos → `en_proceso`, todos completados → `completado`
**Archivos:** `crear-despacho.tsx`, `DespachoTabs.tsx`, `detalle.tsx`, `lib/estados/config.ts`

### 3. Incidencias API 500 — Primera iteración
**Problema:** POST /api/incidencias devolvía 500.  
**Causa 1:** Usaba `supabase` (con RLS del usuario) para insert. RLS policies de incidencias_viaje son muy restrictivas para inserts cross-empresa.  
**Fix 1:** Cambio a `supabaseAdmin` para viaje lookup e incidencia insert.  
**Archivo:** `pages/api/incidencias/index.ts`

### 4. Incidencias API 500 — Segunda iteración  
**Problema:** Seguía fallando después del fix anterior.  
**Causa 2:** Columna `documentos_afectados` no existía en la tabla (migration 064 no ejecutada).  
**Fix 2:** Removidas referencias a `documentos_afectados` del insert y select. Mejorado logging y error responses.  
**Archivo:** `pages/api/incidencias/index.ts`

### 5. Migration 064 ejecutada
**Acción:** Usuario ejecutó `064_incidencias_sistema_provisorio.sql` en Supabase.  
**Efecto:** Columna `documentos_afectados` JSONB ahora existe, CHECK constraints actualizados, índices y RLS policies creados.

### 6. Auto-ensure usuario en tabla `usuarios`
**Problema potencial:** FK `reportado_por REFERENCES usuarios(id)` de migraciones antiguas.  
**Fix:** API verifica si userId existe en tabla `usuarios` y crea registro si no existe.

---

## Decisiones Tomadas

- **DEC-024:** Badges estados-camiones unificados para todos los roles (6 badges)
- **DEC-025:** Estado visual de despacho se computa desde viajes, no del campo `estado` de BD
- **DEC-026:** `supabaseAdmin` permitido para INSERT incidencias (write-once, RLS restrictivas)

---

## Pendiente Próxima Sesión

1. Restaurar `documentos_afectados` en API incidencias (migration 064 ya ejecutada)
2. Verificar creación de incidencias E2E
3. Migration 063 pendiente ejecución
4. Preparación datos demo
5. Script/guión de demo

---

## Estado del Build

✅ Build limpio (clean rebuild sin errores)
