# Sesión 19 — 14-Feb-2026

## Security Hardening + DB Sync PROD + Deploy Vercel + PROD Testing

**Duración:** ~6 horas  
**Modelo:** Claude Opus  
**Equipo:** Opus (Tech Lead) + Usuario (PO/Tester)

---

## Resumen Ejecutivo

Sesión enfocada en llevar Nodexia-Web a producción: completar hardening de seguridad de todas las API routes, sincronizar la base de datos de PROD con DEV, deployar a Vercel, y hacer testing real en PROD. Se descubrieron y corrigieron múltiples diferencias entre ambos entornos.

---

## Logros Detallados

### 1. Security Hardening — 55/55 API Routes ✅
- Completado en fases previas (1-4), verificado en esta sesión
- TODAS las rutas usan `withAuth` middleware
- `withAdminAuth` completamente eliminado → `withAuth({ roles: [...] })`

### 2. DB Sync PROD ↔ DEV ✅
- PROD tenía 55 tablas (legacy), DEV 37 (cleaner)
- Creados 6 scripts SQL consolidados:
  - Part 1: Columns (ALTER TABLE additions)
  - Part 2: 12 missing tables
  - Part 3: ~60 indexes
  - Part 4: ~30 functions + triggers
  - Part 5: 10 views
  - Part 6: RLS + security policies
- **5 rondas de fixes** por diferencias PROD vs DEV:
  - Round 1: `limpiar_notificaciones_antiguas()` return type, `scheduled_date_time` → `scheduled_at`
  - Round 2: `nombre_comercial` → `nombre`, `rol_global` → super_admins table
  - Round 3: "cannot drop columns from view" → DROP VIEW IF EXISTS
  - Round 4: `d.empresa_id` / `d.origen_empresa_id` no existen en despachos → `d.created_by`
  - Round 5: All 6 parts executed successfully ✅

### 3. empresa_id Migration ✅
- choferes: 28/30 valid, 2 orphans (invalid id_transporte)
- camiones: migrated from id_transporte
- acoplados: migrated from id_transporte
- Additional columns synced: despachos, viajes_despacho, camiones, acoplados

### 4. Security Audit ✅
- Score: Security 6.5/10, Code Structure 7.5/10
- P0 fixes completed:
  1. `delete-despacho.ts` → withAuth (was x-admin-secret)
  2. `INSTRUCCIONES-DEV-EXTERNO.md` → removed demo passwords
  3. `solicitudes/aprobar.ts` → removed password_temporal from audit

### 5. Vercel Cleanup ✅
- Discovered 2 Vercel projects: `nodexia-web` (broken) + `nodexia-web-j6wl` (working)
- `nodexia-web` had Output Directory misconfigured as "next" → user deleted it
- `nodexia-web-j6wl` → www.nodexiaweb.com working ✅

### 6. PROD Testing — Partially Validated ✅
- ✅ Crear despacho (DSP-20260214-001)
- ✅ Generar viaje automáticamente
- ✅ Asignar transporte (Logística Expres)
- ✅ Crear unidad operativa en Flota
- ✅ Asignar unidad a viaje
- ✅ Viaje visible en Despachos Ofrecidos
- **Fix 1:** `scheduled_at` column missing in viajes_despacho PROD → ALTER TABLE
- **Fix 2:** FK names mismatch in despachos-ofrecidos.tsx → updated to use `fk_despachos_origen_ubicacion`

---

## Problemas Encontrados y Resueltos

| Problema | Causa | Fix |
|----------|-------|-----|
| Viaje creation 400 error | `scheduled_at` column missing in PROD | ALTER TABLE viajes_despacho ADD COLUMN |
| Despachos Ofrecidos PGRST200 | FK names `despachos_origen_id_fkey` don't exist in PROD | Changed to `fk_despachos_origen_ubicacion` |
| Part 4 function error | Return type mismatch | DROP FUNCTION before CREATE |
| Part 5 view errors | Column names differ PROD vs DEV | Fixed column references |
| Part 6 RLS errors | despachos missing empresa columns | Used created_by instead |

---

## Commits

| Hash | Description |
|------|-------------|
| `f08d0ce` | Phase 4 security hardening |
| `8a2654f` | 6 SQL sync scripts |
| `86812fb` | Script fixes round 1 |
| `3b7915a` | Script fixes round 2 |
| `d70d8b0` | Script fixes round 3 |
| `cc391b1` | Script fixes round 4 |
| `aa2ce0e` | Security P0 fixes |
| `002a822` | Fix scheduled_at column |
| `1b7dd24` | Fix FK constraint names |

---

## Pendiente para Próxima Sesión

1. **Testing PROD:** Chofer confirma viaje desde chofer-mobile (credenciales Walter: `walter@logisticaexpres.com`)
2. **Testing PROD:** GPS tracking, flujo completo hasta completado
3. **Testing PROD:** Control de acceso
4. **Security P1:** Rate limiting, CORS para mobile
5. **Verificar:** DEV FK names consistency con código actualizado
6. **Migraciones pendientes:** 055 (historial_despachos), 056 (RLS viajes red)
