# Sesión 13 — 11-Feb-2026

## Estado Sync + Desvincular + Red Nodexia E2E + API Aceptar Oferta

**Duración:** ~4 horas  
**Participantes:** Opus (Tech Lead) + Usuario (PO/Tester)  
**Días para demo:** 7

---

## Objetivos de la Sesión

1. Completar TASK-S28: Sincronización Estado Viaje en Despachos
2. Implementar feature "Desvincular Transporte"
3. Resolver Red Nodexia: tablas faltantes, embed fix, marketplace filtering
4. Testing E2E del flujo Red Nodexia completo
5. Investigar y resolver corrupción de datos DSP-20260211-004

---

## Trabajo Realizado

### 1. TASK-S28: Sincronización Estado Viaje en Despachos ✅

**Problema:** 17 de los 22 estados de viaje caían al default "⏳ Pendiente" porque cada archivo tenía su propio mapa incompleto de colores/labels.

**Solución:**
- Creado `ESTADO_VIAJE_DISPLAY` (35 estados) + `getEstadoDisplay()` centralizado en `lib/helpers/estados-helpers.ts`
- 6 archivos actualizados para usar el display centralizado
- Despacho padre se actualiza automáticamente cuando viajes avanzan (via `estado-unidad.ts`)
- Tab Completados detecta `completado`+`entregado`+`viaje_completado`+`cancelado`

**Archivos modificados:** `lib/helpers/estados-helpers.ts`, `pages/crear-despacho.tsx`, `pages/transporte/viajes-activos.tsx`, `pages/chofer/viajes.tsx`, `components/Transporte/ViajeDetalleModal.tsx`, `pages/coordinator-dashboard.tsx`, `pages/api/viajes/[id]/estado-unidad.ts`

### 2. Feature "Desvincular Transporte" ✅

**Requerimiento:** Coordinador necesita poder desvincular un transporte desde la página de configuración.

**Implementación:**
- Botón "Desvincular" en tabla de transportes vinculados (`pages/configuracion/transportes.tsx`)
- Validación: consulta viajes activos del transporte antes de permitir acción
- Si tiene viajes activos → modal de advertencia, acción bloqueada
- Si no tiene viajes → modal de confirmación, actualiza `relaciones_empresas.estado` → `inactiva`
- Warning inline convertido a modal centrado por solicitud del usuario

### 3. Red Nodexia: Tablas Faltantes ✅

**Problema:** Tabla `ofertas_red_nodexia` no existía en Supabase, causando error 404 en queries.

**Solución:**
- Creado `sql/crear-ofertas-red-nodexia.sql` con DDL para `ofertas_red_nodexia` y `historial_red_nodexia`
- Incluye RLS policies (INSERT para transporte, SELECT para todos los autenticados)
- Usuario ejecutó script en Supabase SQL Editor — 4 tablas Red Nodexia confirmadas

### 4. Red Nodexia: PostgREST Embed Fix ✅

**Problema:** `Could not embed because more than one relationship was found for 'ofertas_red_nodexia'` — PostgREST no podía resolver automáticamente cuál FK usar.

**Causa raíz:** `ofertas_red_nodexia` tiene 2 FKs a `viajes_red_nodexia`:
- `viaje_red_id` → FK directa (la que queremos)
- `oferta_aceptada_id` → FK inversa desde viajes_red

**Solución:** Agregado FK hint `!viaje_red_id` en las 3 queries de `lib/hooks/useRedNodexia.tsx` que hacían embed de ofertas.

### 5. Red Nodexia: Marketplace Filtering ✅

**Problema:** Transportes vinculados directamente a una empresa veían los viajes de esa empresa en el marketplace Red Nodexia, generando duplicados (ya los reciben por vinculación directa).

**Solución en `pages/transporte/cargas-en-red.tsx`:**
- Query a `relaciones_empresas` para obtener empresas vinculadas directamente
- Filtra esos viajes del marketplace
- Viajes con oferta rechazada: borde rojo, opacity-70, banner "asignado a otro transporte", badge "No seleccionado"
- Browser `alert()` reemplazado por modal in-app styled con ícono verde checkmark

### 6. Red Nodexia: Testing E2E ✅

**Flujo validado completo:**
1. Coordinador publica viaje en Red Nodexia ✅
2. Transporte Nodexia ve y acepta viaje ✅ (con modal in-app, no alert)
3. Coordinador ve ofertas y selecciona ganador ✅
4. Transporte rechazado ve badge "No seleccionado" ✅
5. Viaje asignado correctamente al transporte ganador ✅

### 7. DSP-20260211-004: Investigación de Datos Corruptos ✅

**Síntoma:** Viaje del despacho DSP-20260211-004 mostraba como "expirado" con transporte no asignado, a pesar de que el coordinador había aceptado una oferta.

**Investigación (8 queries diagnósticas):**
- `ofertas_red_nodexia`: oferta estaba en estado `pendiente` (no `aceptada`)
- `viajes_despacho`: `id_transporte: null`, `estado: pendiente`
- `viajes_red_nodexia`: `estado_red: con_ofertas` (no `asignado`)

**Causa raíz:** `handleAceptarOfertaDesdeModal` ejecutaba 8 queries client-side:
1. ✅ Update viajes_red_nodexia.oferta_aceptada_id → funcionó
2. ❌ Update ofertas_red_nodexia estado→aceptada → **SIN UPDATE RLS POLICY**
3. ❌ Update otras ofertas→rechazada → **SIN UPDATE RLS POLICY**
4. ❌ Update viajes_red_nodexia estado_red→asignado → funcionó parcialmente
5. ❌ Update viajes_despacho id_transporte → **TRIGGER `get_visible_chofer_ids` permission denied**
6. ❌ Update viajes_despacho estado→transporte_asignado → **TRIGGER bloqueó**
7. ❌ Lookup tabla `transportes` para nombre → **TABLA NO EXISTE**
8. ❌ Update despachos estado→asignado → **bloqueado por cascade de errores**

### 8. API Route Aceptar Oferta ✅

**Solución definitiva:** Creado `pages/api/red-nodexia/aceptar-oferta.ts` (~140 líneas)
- Usa `SUPABASE_SERVICE_ROLE_KEY` para bypasear toda la RLS y triggers
- 8 pasos atómicos: get viaje_red → get viaje_despacho → accept oferta → reject others → update viaje_red → update viaje_despacho (estado + id_transporte) → update despacho → return nombre transporte
- `handleAceptarOfertaDesdeModal` en `crear-despacho.tsx` refactored: 1 `fetch()` en vez de 8 queries

### 9. Fix Datos DSP-20260211-004 ✅

**Datos reparados manualmente con service role script:**
- Oferta: estado `pendiente` → `aceptada`
- Viaje: estado `pendiente` → `transporte_asignado`, id_transporte → UUID transporte
- viajes_red_nodexia: estado_red → `asignado`
- Despacho: estado → `asignado`

**Pendiente para sesión 14:** Chofer/camión no se muestran en viaje (`chofer_id: null`, `camion_id: null`). El transporte asignó chofer pero el viaje no refleja los recursos.

---

## Archivos Afectados

### Creados (2):
- `pages/api/red-nodexia/aceptar-oferta.ts` — API handler service role (~140 líneas)
- `sql/crear-ofertas-red-nodexia.sql` — Migración ofertas + historial Red Nodexia

### Modificados (10):
- `lib/helpers/estados-helpers.ts` — ESTADO_VIAJE_DISPLAY (35) + getEstadoDisplay()
- `lib/hooks/useRedNodexia.tsx` — FK hints `!viaje_red_id`, filtro 'asignado'
- `pages/crear-despacho.tsx` — handleAceptarOfertaDesdeModal → API, badges centralizados
- `pages/transporte/cargas-en-red.tsx` — Filtering vinculados, rejected display, modal
- `pages/configuracion/transportes.tsx` — Desvincular con modal + validación viajes
- `pages/transporte/viajes-activos.tsx` — getEstadoBadge centralizado + LEDs
- `pages/chofer/viajes.tsx` — Mapas color/label completos (28/30 estados)
- `components/Transporte/ViajeDetalleModal.tsx` — ESTADOS array 6→22
- `pages/coordinator-dashboard.tsx` — getEstadoBadge 4→27 estados
- `pages/api/viajes/[id]/estado-unidad.ts` — Sync despacho padre automático

---

## Decisiones Técnicas

1. **API service role para aceptar ofertas:** La falta de UPDATE RLS policy en ofertas_red_nodexia y los triggers de viajes_despacho hacen imposible la actualización client-side. El patrón API + service_role es la solución estándar del proyecto.

2. **FK hint como patrón:** Toda query que haga embed de `ofertas_red_nodexia` debe usar `!viaje_red_id` para disambiguar las 2 FKs.

3. **`relaciones_empresas` como fuente de vinculaciones:** El marketplace Red Nodexia filtra viajes de empresas vinculadas directamente para evitar duplicados.

4. **Modal in-app vs browser alert:** Toda interacción de confirmación usa modales styled consistentes con el design system.

5. **Desvincular = inactivar, no borrar:** `relaciones_empresas.estado` → `inactiva` preserva historial.

---

## Datos de Referencia

| Entidad | ID |
|---|---|
| DSP-20260211-004 despacho | `1277804d-5df3-41d9-b2df-b80b31b591dc` |
| Viaje #1 | `7abcf409-c751-402f-b3ae-8763e8ef4270` |
| Transporte Nodexia | `e3c56f6c-31a8-49e0-9cb2-4c94302c25a8` |
| Oferta aceptada | (verificar en ofertas_red_nodexia) |

---

## Próximos Pasos (Sesión 14)

1. **BUG: DSP-20260211-004 chofer/camión no muestra** — Investigar si el transporte realmente asignó los recursos o si es bug de display (chofer_id/camion_id null en viajes_despacho)
2. **Feature: Historial/Timeline de eventos** — Sistema de auditoría robusto para despachos, investigar UX de mejores plataformas
3. **TASK-S26: Fase 5 Destino** — CA ingreso/egreso en destino
4. **TASK-S27: Cierre automático** — vacío → viaje_completado
5. **RLS gap:** Agregar UPDATE policy a ofertas_red_nodexia (aunque API bypasea)
