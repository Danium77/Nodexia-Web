# Sesión 28 — 19-Feb-2026

## Resumen
E2E testing entre Aceitera San Miguel (origen) y Tecnopack Zayas (destino). Corrección de bug crítico de completado de viaje, implementación de badges por rol para Control de Acceso, y diseño completo del sistema de incidencias.

## Logros Principales

### 1. Auto-completar viaje tras egreso destino
- **Problema:** DSP-20260219-001 no transitaba a `completado` después de `egreso_destino`
- **Causa raíz:** `sincronizarDespacho()` solo copiaba el estado del viaje al despacho, pero `DespachoTabs` filtra por `['completado', 'cancelado']` — `egreso_destino` no calificaba
- **Solución:** Encadenamiento automático en `cambiarEstadoViaje()`: cuando viaje llega a `egreso_destino`, auto-transiciona a `completado` (actualiza viaje + despacho + estado_unidad_viaje + historial con flag `auto: true`)
- **Archivos:** `lib/services/viajeEstado.ts`

### 2. Badges simplificados para Control de Acceso
- **Problema:** 11 badges operativos eran excesivos para rol control_acceso
- **Solución:** 5 badges contextuales: En Planta, Por Arribar, Cargando, Descargando, Egresados
- **Lógica especial:** "Por Arribar" filtra solo fecha_despacho <= hoy (nunca futura)
- **Archivos:** `pages/estados-camiones.tsx`

### 3. Diseño sistema de incidencias
- **Auditoría:** 2 tablas incompatibles, hook queries tabla equivocada, tipos TS no coinciden con BD, sin CRUD completo
- **Diseño:** Tabla canónica `incidencias_viaje`, flujo de estados, permisos por rol, plan de 8 fases
- **Archivos:** `docs/diagramas/INCIDENCIAS.md`

### 4. Fix manual DSP-20260219-001
- Script con service role para actualizar viaje + despacho + estado_unidad_viaje a `completado`

## Decisiones
- **DEC-020:** `incidencias_viaje` es tabla canónica, deprecar `incidencias`
- **DEC-021:** CA ve 5 badges, otros roles ven 11
- **DEC-022:** Auto-completar viaje al confirmar egreso de destino
- **DEC-023:** "Por Arribar" solo muestra fecha_despacho hoy o anterior

## Archivos Modificados
- `lib/services/viajeEstado.ts` — Auto-completar egreso→completado
- `pages/estados-camiones.tsx` — Badges por rol
- `lib/contexts/UserRoleContext.tsx` — cuitEmpresa
- `pages/control-acceso.tsx` — Historial, QR, banner

## Archivos Creados
- `docs/diagramas/INCIDENCIAS.md`

## Próxima Sesión
1. Implementar incidencias (8 fases, ~5-6h)
2. Migration 063 ejecución
3. Datos demo para presentación 28-Feb
