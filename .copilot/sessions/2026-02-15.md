# Sesión 22 — 15-Feb-2026 (Sábado)

## Testing E2E PROD — 8 Bugs Fix Intensivo

**Tiempo:** ~4 horas  
**Equipo:** Opus (Tech Lead) + Usuario (PO/Tester E2E)  
**Foco:** Testing end-to-end del flujo completo chofer↔viaje en PROD (www.nodexiaweb.com)

---

## Resumen Ejecutivo

Sesión de testing E2E intensivo en PROD. Se recorrió el flujo completo:
**vincular chofer → asignar viaje → confirmar viaje → iniciar viaje → GPS tracking**

Cada paso reveló bugs que fueron corregidos y deployados inmediatamente.
Total: **8 bugs encontrados y resueltos**, todos deployados a PROD.

---

## Bugs Corregidos (cronológico)

### Bug 1: id_transporte NULL al vincular chofer
**Error:** `null value in column "id_transporte" of relation "choferes" violates not-null constraint`
**Causa:** `addChofer` en useChoferes.tsx solo seteaba `empresa_id` pero la tabla tiene `id_transporte` NOT NULL
**Además:** choferes.tsx seteaba `id_transporte: currentUserId` (UUID del usuario, incorrecto — debe ser empresa UUID)
**Fix:** Setear `id_transporte = empresa_id` en hook + remover asignación incorrecta en page
**Commit:** `8f9e73f`

### Bug 2: Duplicate DNI al re-vincular chofer
**Error:** "Ya existe un chofer con ese DNI" al intentar vincular Walter Zayas (previamente desvinculado)
**Causa:** El chofer existía con `empresa_id=NULL` (desvinculado), pero INSERT fallaba por DNI duplicado
**Fix:** Detectar chofer existente por DNI → UPDATE (re-link) en vez de INSERT
**Commit:** `b057bde`

### Bug 3: Panel de estados LEDs no se enciende
**Síntoma:** LEDs del panel de estados en viajes-activos no mostraban el estado correcto
**Causa:** Panel usaba solo `viajesParaMapa` (seleccionados) y leía `estado_unidad_viaje` (tabla secundaria) en vez de `estado` (campo principal)
**Fix:** Usar `viajes.map(v => v.estado)` — todos los viajes, campo estado principal
**Commit:** `d1d566b`

### Bug 4: CHECK constraint al confirmar viaje desde chofer-mobile
**Error:** `viajes_despacho_estado_unidad_check` constraint violation al cambiar a `confirmado_chofer`
**Causa:** Migración 015_v2 creó CHECK constraint SIN incluir `confirmado_chofer` y otros estados nuevos. Migraciones 058/059 actualizaron CHECK en `estado_unidad_viaje` pero NO en `viajes_despacho`
**Fix:** SQL `fix_viajes_despacho_estado_unidad_check.sql` con los 17+1 estados completos, ejecutado en PROD
**Commit:** `ca0b7f5`

### Bug 5: Historial de eventos no registra cambios de estado
**Síntoma:** "Chofer confirmado" no aparecía en historial/timeline de despachos
**Causa:** `cambiarEstadoViaje()` no escribía timestamps en `viajes_despacho` ni insertaba eventos en `historial_despachos`
**Fix:** Agregado `ESTADO_A_TIMESTAMP_VIAJE` mapping + `ESTADO_A_DESCRIPCION` mapping + insert en historial_despachos + update timestamp en viajes_despacho
**Commit:** `ca0b7f5`

### Bug 6: Botones "Navegar al Origen/Destino" no visibles
**Síntoma:** Chofer-mobile no mostraba botones de navegación Maps
**Causa:** Botones condicionados a `latitud && longitud` existentes, pero ubicaciones PROD no tenían coordenadas
**Fix:** Botones siempre visibles, usan coordenadas si existen o fallback a búsqueda por dirección en Maps
**Commit:** `f5ae794`

### Bug 7: Modal crear ubicación sin campos de coordenadas
**Síntoma:** No había forma de cargar lat/lng al crear ubicaciones
**Fix:** Agregados campos Latitud y Longitud en CrearUbicacionModal con tip text
**Commit:** `f5ae794`

### Bug 8: GPS tracking "No puedes enviar ubicación de un viaje que no es tuyo"
**Error:** API registrar-ubicacion.ts rechazaba todas las peticiones
**Causa:** Verificación comparaba `chofer.email` con `auth.user.email`, pero tabla choferes NO tiene columna email → `chofer.email` siempre `undefined`
**Fix:** Comparar `chofer.usuario_id === userId` (vinculación correcta chofer↔usuario)
**Commit:** `716e5c3`

---

## Archivos Modificados (8)

| Archivo | Cambio |
|---------|--------|
| `lib/hooks/useChoferes.tsx` | addChofer: set id_transporte + re-link existente por DNI |
| `pages/transporte/choferes.tsx` | Removido id_transporte=currentUserId, limpieza console.logs |
| `pages/transporte/viajes-activos.tsx` | Estados panel: todos los viajes, campo estado principal |
| `lib/services/viajeEstado.ts` | ESTADO_A_TIMESTAMP_VIAJE + ESTADO_A_DESCRIPCION + historial insert |
| `pages/chofer-mobile.tsx` | Botones Maps siempre visibles con fallback a dirección |
| `components/Modals/CrearUbicacionModal.tsx` | Campos lat/lng para coordenadas |
| `pages/api/gps/registrar-ubicacion.ts` | Auth: usuario_id en vez de email |
| `sql/fix_viajes_despacho_estado_unidad_check.sql` | CHECK constraint 17+1 estados (ejecutado PROD) |

## Archivos Creados (1)

| Archivo | Descripción |
|---------|-------------|
| `sql/fix_viajes_despacho_estado_unidad_check.sql` | Fix CHECK constraint viajes_despacho |

---

## Commits (6)

1. `8f9e73f` — fix: Set id_transporte on chofer insert (NOT NULL constraint)
2. `b057bde` — fix: Re-vincular chofer existente en vez de insertar duplicado
3. `d1d566b` — fix: Panel de estados muestra todos los viajes, no solo seleccionados
4. `ca0b7f5` — fix: Registrar cambios de estado en historial y timestamps de viaje
5. `f5ae794` — feat: Ubicaciones - siempre mostrar navegación Maps + campos coordenadas
6. `716e5c3` — fix: GPS tracking - verificar chofer por usuario_id, no por email

---

## Decisiones Técnicas

### DEC-012: Chofer re-link por UPDATE en vez de INSERT
- Si un chofer fue desvinculado (empresa_id=NULL) y se vuelve a vincular, se hace UPDATE del registro existente
- Preserva historial, IDs, y datos del chofer original

### DEC-013: Botones de navegación Maps siempre visibles
- No dependen de que la ubicación tenga coordenadas cargadas
- Fallback: búsqueda por dirección en Google/Apple Maps
- Mejor UX para el chofer

### DEC-014: Auth chofer por usuario_id, no por email
- La tabla choferes no tiene columna email
- La vinculación correcta es `choferes.usuario_id ↔ auth.users.id`
- Cualquier verificación de propiedad chofer↔usuario debe usar este campo

---

## Estado al Cierre

### Flujo E2E Validado en PROD:
- ✅ Vincular chofer por DNI (nuevo + re-vincular existente)
- ✅ Desvincular chofer
- ✅ Crear despacho con viaje
- ✅ Asignar transporte
- ✅ Crear unidad operativa (chofer+camión)
- ✅ Asignar unidad a viaje
- ✅ Chofer confirmar viaje desde chofer-mobile
- ✅ Chofer iniciar viaje (en_transito_origen)
- ✅ Panel de estados LED refleja estado correcto
- ✅ Historial registra cambios de estado
- ✅ Botones navegar a origen/destino funcionan
- ✅ GPS tracking auth corregido (pendiente re-test por usuario)

### Pendiente de Testing:
- ⬜ Re-test GPS tracking (fix recién deployado)
- ⬜ Flujo completo: ingresado_origen → carga → egreso → destino → completado
- ⬜ Control de acceso roles (CA, supervisor) en PROD
- ⬜ Despachos ofrecidos / cargas en red

### Para Próxima Sesión:
- Confirmar GPS tracking funciona
- Continuar E2E testing del flujo completo
- Evaluar tareas pre-demo (quedan 3 días → 18-Feb-2026)
- Considerar preparación de datos demo
