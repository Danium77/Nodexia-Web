# Sesión 11 — 10-Feb-2026 (Continuación)

## Resumen
Flujo operativo completo end-to-end: Supervisor sube foto remito → CA valida remito y registra egreso → Chofer inicia viaje a destino → Chofer arriba destino → Chofer finaliza viaje. Múltiples bugs de RLS/tablas/estados corregidos. Documento de esquema general creado.

## Contexto de Entrada
- Sesión 10 terminó con supervisor-carga reescrito y 3 bugs fixeados
- El flujo remito/egreso/chofer no había sido testeado end-to-end

## Cambios Realizados

### 1. Remito: Upload + Consulta via API Routes
- **Problema**: Storage bucket `remitos` no existía → creado (público, 10MB)
- **Problema**: RLS bloqueaba uploads e inserts en `documentos_viaje_seguro`
- **Solución**: Creadas 2 API routes server-side con service_role:
  - `pages/api/upload-remito.ts` — Upload multipart (formidable), valida JWT, sube a bucket, inserta en tabla
  - `pages/api/consultar-remito.ts` — Consulta remito por viaje_id, bypasea RLS
- **Descubrimiento**: Tabla `documentos_viaje` NO EXISTE → real es `documentos_viaje_seguro`
- **Schema descubierto**: viaje_id, tipo, nombre_archivo(NOT NULL), file_url(NOT NULL), storage_path(NOT NULL), fecha_emision(NOT NULL), subido_por(NOT NULL)

### 2. Control de Acceso: Validación de Remito + Egreso
- `control-acceso.tsx`: Agregados `cargado`/`descargado` a ESTADOS_UNIDAD_VALIDOS
- Nuevos estados: remitoUrl, remitoValidado, cargandoRemito, showRemitoPreview
- Fetch remito cambiado de query directa a `/api/consultar-remito`
- UI: preview thumbnail, click-to-expand, "Validar Remito" button, egreso condicional

### 3. Chofer Web App: Viajes via API Route
- **Problema**: RLS bloqueaba queries del chofer autenticado → 0 viajes
- **Solución**: `pages/api/chofer/viajes.ts` — API route con service_role, busca chofer por email/user_id, devuelve viajes con joins
- `pages/chofer/viajes.tsx`: Reemplazada query directa por fetch a API route

### 4. API estado-unidad: Reescrita sin RPC
- **Problema**: `supabase.rpc('actualizar_estado_unidad')` no existía en BD
- **Solución**: Reescrita `pages/api/viajes/[id]/estado-unidad.ts` con:
  - Tabla TRANSICIONES_VALIDAS (mapa completo de estados)
  - Validación de transición
  - Update directo con service_role
  - Sin timestamps de columnas inexistentes

### 5. Transiciones de Estado Completadas
- `arribado_destino` → `vacio` habilitado (destino sin Nodexia)
- `arribado_destino` → `ingresado_destino` (destino con Nodexia)
- Flujo completo testeado: egreso_origen → en_transito_destino → arribado_destino → vacio

### 6. Display de Estados Corregido
- `crear-despacho.tsx`: Agregado `arribado_destino` a CSS y labels (antes mostraba "Pendiente")
- `crear-despacho.tsx`: Eliminada exclusión de `fuera_de_horario` en tabs Asignados/En Proceso
- `viajes-activos.tsx`: Agregado `arribado_destino` al filtro `.in('estado', [...])`, mapa de estilos, y contador de tránsito

### 7. Documentación
- Creado `docs/ESQUEMA-GENERAL-NODEXIA.md` — Mapa completo del sistema: 6 fases, roles, estados, tablas, API routes

## Archivos Creados
```
pages/api/upload-remito.ts          (~95 líneas) — Upload foto remito
pages/api/consultar-remito.ts       (~55 líneas) — Consulta remito por viaje
pages/api/chofer/viajes.ts          (~100 líneas) — Viajes del chofer (bypass RLS)
docs/ESQUEMA-GENERAL-NODEXIA.md    (~250 líneas) — Mapa operativo completo
```

## Archivos Modificados
```
pages/supervisor-carga.tsx          — subirFotoRemito() usa API route
pages/control-acceso.tsx            — Remito preview+validación, estados cargado/descargado
pages/chofer/viajes.tsx             — cargarViajes() usa API route
pages/api/viajes/[id]/estado-unidad.ts — Reescrito: sin RPC, transiciones validadas
pages/crear-despacho.tsx            — arribado_destino en labels, fuera_de_horario no excluye
pages/transporte/viajes-activos.tsx — arribado_destino en filtros y estilos
docs/PENDIENTE-CRITICO-SEGURIDAD-API.md — Agregadas Fases 5-8 post-MVP
```

## Resultado del Testing
- ✅ Supervisor sube foto de remito → storage + BD OK
- ✅ CA ve preview del remito, lo valida, registra egreso
- ✅ Chofer ve viaje en web app móvil (antes: 0 viajes por RLS)
- ✅ Chofer inicia viaje a destino (egreso_origen → en_transito_destino)
- ✅ Chofer arriba a destino (en_transito_destino → arribado_destino)
- ✅ Chofer finaliza viaje (arribado_destino → vacio)
- ✅ Viajes activos muestra viaje en estado vacio con mapa
- ✅ Panel de estados marca correctamente "Vacío"
- ✅ FLUJO COMPLETO E2E TESTEADO Y FUNCIONANDO

## Bugs Encontrados y Resueltos
1. Bucket `remitos` no existía → creado
2. RLS bloqueaba insert en `documentos_viaje_seguro` → API route bypass
3. Tabla `documentos_viaje` no existe → real es `documentos_viaje_seguro`
4. RLS bloqueaba lectura de remito → API route bypass
5. RLS bloqueaba viajes del chofer → API route bypass
6. `supabase.rpc('actualizar_estado_unidad')` no existe → update directo
7. Columna `fecha_salida_destino` no existe en viajes_despacho → removido
8. Transición `arribado_destino` → `vacio` no permitida → agregada
9. `arribado_destino` no aparecía en viajes-activos → agregado al filtro
10. `fuera_de_horario` excluía despachos de tabs Asignados/En Proceso → removida exclusión
11. Estado "Pendiente" fallback en crear-despacho → agregados labels faltantes

## Decisiones Técnicas
- **Patrón API Route + service_role**: Adoptado como solución estándar para bypasear RLS. 4 endpoints nuevos. JWT siempre validado primero. Documentado como deuda técnica post-MVP.
- **Transiciones de estado en código**: Tabla TRANSICIONES_VALIDAS en JS en vez de función PostgreSQL (la RPC no existía). Más mantenible y testeable.
- **Destino sin Nodexia**: Chofer puede ir directo de `arribado_destino` → `vacio` sin pasar por CA/Supervisor de destino.

## Estado al Cierre
- 8 días para demo (18-Feb-2026)
- Flujo operativo completo funciona E2E
- Fase 5 (destino con Nodexia) pendiente pero no bloqueante para demo
- Esquema general documentado para referencia futura
