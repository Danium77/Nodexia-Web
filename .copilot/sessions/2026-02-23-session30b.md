# Sesión 30b — 23-Feb-2026

## UX Polish: Heartbeat Spinner + Parallel Queries + Sidebar/Nav Fixes

**Duración:** ~1.5 horas  
**Commit:** `7a88214`

---

## Resumen

Testing en producción reveló 3 problemas de UX previo a demo del 28-Feb:
1. Spinners de carga inconsistentes (border-spin, SVG, texto) → Unificado con logo Nodexia X + heartbeat
2. Planificación carga lenta (10 queries seriales) → 5 fases paralelas con Promise.all
3. Sidebar colapsa robando clicks + logout sin feedback → Delay 300ms + spinner logout

También se sincronizó BD PROD con migraciones 060, 061, 063, 064 pendientes.

---

## Cambios Detallados

### 1. LoadingSpinner Unificado
- **Archivo:** `components/ui/LoadingSpinner.tsx`
- Logo `logo X gruesa.png` con `animate-nodexia-heartbeat` (scale pulse)
- Glow ring cyan con `animate-nodexia-glow` (box-shadow pulse)
- Props: size (sm/md/lg/xl), text, fullScreen
- `ButtonSpinner` export para spinners inline en botones
- 9 páginas ya usaban `<LoadingSpinner>` — heredan automáticamente

### 2. Animaciones CSS
- **Archivo:** `styles/globals.css`
- `@keyframes nodexia-heartbeat`: 1.4s ease-in-out infinite, scale 1→1.12→0.97→1.06→1
- `@keyframes nodexia-glow`: 1.4s ease-in-out infinite, box-shadow cyan pulse
- Registradas en `@theme inline` para Tailwind v4

### 3. Page Transition Overlay
- **Archivo:** `pages/_app.tsx`
- Router events: `routeChangeStart` → show spinner, `routeChangeComplete`/`Error` → hide
- `<LoadingSpinner fullScreen text="Cargando..." />` como overlay z-50

### 4. Sidebar Fixes
- **Archivo:** `components/layout/Sidebar.tsx`
- `onMouseLeave` delay 300ms via `useRef<setTimeout>` — previene collapse que roba clicks
- `onMouseEnter` cancela timer pendiente — expand inmediato
- Logout: estado `loggingOut`, botón disabled + spinner + "Cerrando..."

### 5. Planificación Performance
- **Archivo:** `pages/planificacion.tsx`
- De ~10 serial DB round-trips a 5 parallel phases
- Phase 1: empresa (sequential)
- Phase 2: Promise.all(users, ubicaciones, transportes filter, métricas) — 4 queries
- Phase 3: Promise.all(despachos, recepciones) — 2 queries
- Phase 4: Promise.all(viajes, ubicaciones all) — 2 queries
- Phase 5: Promise.all(enrichment combined) — 3 queries, IDs de despachos+viajes en single pass
- ~130 líneas de código removidas (logs debug + queries duplicadas)

### 6. PROD DB Sync
- Migraciones 060, 061, 063 ejecutadas directamente
- Migración 064 falló → `ubicaciones.empresa_id` no existía en PROD
- Fix: ALTER TABLE ADD COLUMN + INDEX + backfill via CUIT match
- 5/8 ubicaciones recibieron empresa_id (3 sin match = datos test)

---

## Decisiones

- **DEC-030:** Spinner unificado con logo Nodexia X heartbeat
- **DEC-031:** Page transitions con Router events overlay

---

## Próxima Sesión

1. **EVALUACIÓN ARQUITECTURA** para equipos Frontend/Backend/BD/Android/iOS
2. Verificar incidencias E2E completo
3. Preparación datos demo
4. Remaining inline spinners (53 button/section level — baja prioridad)
