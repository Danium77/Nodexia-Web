# Sesiones 33-34 — 01-Mar-2026

## Schema Sync PROD + Coordinador Integral PyME Complete

**Duración:** ~3 horas (2 sesiones)  
**Equipo:** Opus (Tech Lead) + Usuario (PO)

---

## Sesión 33 — Schema Sync PROD↔DEV

### Objetivos:
- Crear sistema de tracking de migraciones
- Sincronizar esquema PROD con DEV

### Logros:
1. **Migration tracking (068)** — Tabla `schema_migrations`, script `run-migration.js`, docs
2. **Multi-environment** — `migrate:dev`, `migrate:prod`, `migrate:diff` commands
3. **Schema sync (069-074)** — 527 diferencias → 5 irrelevantes
4. **067 fixes** — Auto-detect columns, conditional tables para PROD

### Commits:
- `81f87f1` — feat: migration tracking system (068)
- `4db464e` — feat: multi-environment migration support
- `60f611a` — fix: migrate status null checksum bug
- `49a25a7` — feat: sync PROD schema (069-074)

---

## Sesión 34 — Coordinador Integral PyME

### Objetivos:
- Hacer que `coordinador_integral` tenga acceso completo a todas las funciones de planta
- Añadir campo `referencia_cliente` al formulario de despachos

### Auditoría Previa:
Se auditaron 30+ checkpoints de rol en el codebase. Hallazgos:

| Prioridad | Issue | Archivos |
|-----------|-------|----------|
| HIGH | withAuth solo heredaba 'coordinador' | withAuth.ts |
| HIGH | Sidebar sin menú dedicado | Sidebar.tsx |
| HIGH | 10 estados de viaje bloqueados | config.ts |
| MEDIUM | Header sin UbicacionSelector | Header.tsx |
| MEDIUM | estados-camiones sin flag | estados-camiones.tsx |
| LOW | useUbicacionActual sin flag | useUbicacionActual.ts |

### Correcciones Implementadas:

#### 1. withAuth.ts — Role Inheritance (4 roles)
```typescript
if (rolInterno === 'coordinador_integral') {
  effectiveRoles.push('coordinador', 'control_acceso', 'supervisor', 'administrativo');
}
```

#### 2. Sidebar.tsx — Menú dedicado (11 ítems)
Panel de control, Planificación, Despachos, Control de Acceso, Supervisor de Carga, Estados de Camiones, Viajes, Documentación, Incidencias, Estadísticas, Configuración

#### 3. Header.tsx — UbicacionSelector
```typescript
{(primaryRole === 'control_acceso' || primaryRole === 'coordinador_integral') && <UbicacionSelector />}
```

#### 4. estados-camiones.tsx — esControlAcceso
```typescript
const esControlAcceso = primaryRole === 'control_acceso' || primaryRole === 'coordinador_integral';
```

#### 5. referencia_cliente — Form field completo
- FormDispatchRow interface: `referencia_cliente: string`
- Input UI: "Ref. Cliente (NP/OC)", placeholder "Ej: NP-2026-0845, OC-12345"
- Save/load/display badge en DespachoTableRow

#### 6. ROLES_AUTORIZADOS — 11 transiciones de estado
Añadido `coordinador_integral` a: INGRESADO_ORIGEN, LLAMADO_CARGA, CARGANDO, CARGADO, EGRESO_ORIGEN, EN_TRANSITO_DESTINO, INGRESADO_DESTINO, LLAMADO_DESCARGA, DESCARGANDO, DESCARGADO, EGRESO_DESTINO

#### 7. useUbicacionActual — requiereUbicacion
```typescript
requiereUbicacion: (role === 'control_acceso' || role === 'coordinador_integral') && !ubicacionActualId
```

### Commits:
- `0067fd7` — feat: coordinador_integral PyME - complete role coverage (7 files, +63/-7)
- `297d5a2` — fix: coordinador_integral - add to ROLES_AUTORIZADOS + ubicacion flag (2 files, +12/-12)

### Verificación:
- `pnpm build` — SUCCESS (0 errores)
- Auditoría sub-agente: 30+ checkpoints verificados, todos OK
- Ambos commits pusheados a main → Vercel auto-deploy

---

## Pendiente para próxima sesión:

### Inmediato:
- [ ] Migration 063 en PROD (RLS documentos_viaje_planta)
- [ ] NOTIFY pgrst, 'reload schema' en PROD
- [ ] Testing coordinador_integral en PROD

### PyME Features pendientes:
- [ ] UI toggle `tiene_flota_propia` en configuración empresa
- [ ] UI gestión `vendedor_clientes` (asignaciones vendedor-cliente)

### Otros pendientes:
- [ ] Evaluación arquitectura para equipos (Frontend/Backend/BD/Mobile)
- [ ] Security P1 (rate limiting, CORS, crypto)
- [ ] Testing Red Nodexia flow en PROD
